<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>诊断报告 {{ report["id"] }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge-sev-critical { background:#dc3545; }
    .badge-sev-major { background:#fd7e14; }
    .badge-sev-minor { background:#0dcaf0; color:#111; }
    .badge-overt { background:#6f42c1; }
    .badge-covert { background:#198754; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  {% set r = report["result"] %}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h4 class="mb-1">翻译质量诊断报告：{{ report["id"] }}</h4>
      <div class="text-muted small">
        框架：House 功能—语用等值（语义/语用/篇章/语域/语类实现） ·
        profile: {{ report.get("profile","") }} · model: {{ report.get("model","") }}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/">新建诊断</a>
      <a class="btn btn-success" href="/api/export/{{ report['id'] }}.xlsx">导出 Excel</a>
    </div>
  </div>

  <div class="row g-3">
    <!-- 总览 -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="fw-semibold">总分（House 功能—语用等值框架，100）</div>
          <div class="display-5">{{ r["total_score"] }}</div>
          <div class="text-muted">{{ r["overall_summary"] }}</div>

          <hr/>
          <div class="small text-muted mb-2">维度得分（A–E）</div>

          {% for dim in r["dimensions"] %}
            <div class="mb-2">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ dim["code"] }} · {{ dim["name"] }}</div>
                <div>{{ dim["score"] }}/{{ dim["max_score"] }}</div>
              </div>
              {% set pct = (dim["score"] / dim["max_score"] * 100) if dim["max_score"] else 0 %}
              <div class="progress" role="progressbar" aria-valuenow="{{ pct|round(0) }}" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" style="width: {{ pct }}%"></div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <details class="mt-3 card shadow-sm border-0">
        <summary class="card-body fw-semibold">查看原文与译文</summary>
        <div class="card-body pt-0">
          <div class="fw-semibold mb-1">原文</div>
          <pre class="mono bg-white border rounded p-2">{{ report["source"] }}</pre>
          <div class="fw-semibold mb-1">译文</div>
          <pre class="mono bg-white border rounded p-2">{{ report["target"] }}</pre>
        </div>
      </details>
    </div>

    <!-- 维度详情 -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="mb-3">按 Rubric 维度的扣分点与修改建议</h5>

          <div class="accordion" id="rubricAcc">
            {% for dim in r["dimensions"] %}
              {% set dim_id = "dim_" ~ dim["code"] %}

              {% if dim["code"] == "A" %}
                {% set house_map = "semantic meaning / overt errors" %}
              {% elif dim["code"] == "B" %}
                {% set house_map = "pragmatic meaning / covert errors" %}
              {% elif dim["code"] == "C" %}
                {% set house_map = "textual meaning" %}
              {% elif dim["code"] == "D" %}
                {% set house_map = "register: field / tenor / mode" %}
              {% else %}
                {% set house_map = "genre & linguistic realization" %}
              {% endif %}

              <div class="accordion-item">
                <h2 class="accordion-header" id="h_{{ dim_id }}">
                  <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                          data-bs-toggle="collapse" data-bs-target="#c_{{ dim_id }}"
                          aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="c_{{ dim_id }}">
                    <div class="w-100 d-flex flex-wrap justify-content-between align-items-center gap-2">
                      <div class="fw-semibold">{{ dim["code"] }} · {{ dim["name"] }}</div>
                      <div class="text-muted">
                        House 对应：{{ house_map }} · 得分：{{ dim["score"] }}/{{ dim["max_score"] }} · 扣分点：{{ dim["issues"]|length }}
                      </div>
                    </div>
                  </button>
                </h2>

                <div id="c_{{ dim_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     aria-labelledby="h_{{ dim_id }}" data-bs-parent="#rubricAcc">
                  <div class="accordion-body">
                    <div class="mb-2">
                      <div class="text-muted small">维度说明（rationale）</div>
                      <div>{{ dim["rationale"] }}</div>
                    </div>

                    {% if dim["issues"]|length == 0 %}
                      <div class="text-muted">该维度未发现明显扣分点。</div>
                    {% else %}
                      <div class="table-responsive">
                        <table class="table table-sm align-middle">
                          <thead>
                            <tr>
                              <th style="width: 170px;">标签</th>
                              <th>证据（原文/译文）</th>
                              <th>解释</th>
                              <th style="width: 140px;">建议</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for it in dim["issues"] %}
                              <tr class="{% if it['severity']=='Critical' %}table-danger{% endif %}">
                                <td>
                                  {% if it["severity"] == "Critical" %}
                                    <span class="badge badge-sev-critical">Critical</span>
                                  {% elif it["severity"] == "Major" %}
                                    <span class="badge badge-sev-major">Major</span>
                                  {% else %}
                                    <span class="badge badge-sev-minor">Minor</span>
                                  {% endif %}
                                  <div class="mt-1">
                                    {% if it["error_type"] == "Overt" %}
                                      <span class="badge badge-overt">Overt</span>
                                    {% else %}
                                      <span class="badge badge-covert">Covert</span>
                                    {% endif %}
                                    <span class="badge bg-secondary">-{{ it["delta"] }}</span>
                                  </div>
                                </td>

                                <td class="mono">
                                  {% if it["evidence_source"] %}
                                    <div><span class="text-muted">S:</span> {{ it["evidence_source"] }}</div>
                                  {% endif %}
                                  <div><span class="text-muted">T:</span> {{ it["evidence_target"] }}</div>
                                </td>

                                <td>{{ it["explanation"] }}</td>

                                <td>
                                  <button class="btn btn-sm btn-outline-primary mb-1"
                                          type="button" data-copy="{{ it['suggestion']|e }}">
                                    复制
                                  </button>
                                  <div class="small">{{ it["suggestion"] }}</div>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div class="text-muted small">
                        提示：Critical 表示可能改变核心事实/逻辑/立场；Major 影响理解或明显失真；Minor 多为自然度与格式问题。
                      </div>
                    {% endif %}

                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.querySelectorAll("[data-copy]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const text = btn.getAttribute("data-copy");
      try {
        await navigator.clipboard.writeText(text);
        const old = btn.textContent;
        btn.textContent = "已复制";
        setTimeout(() => btn.textContent = old, 800);
      } catch (e) {
        alert("复制失败，请手动复制。");
      }
    });
  });
</script>
</body>
</html>
