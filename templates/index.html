<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Translation QA Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea { resize: vertical; }
    .hint { font-size: 0.92rem; color: #6c757d; }
    .sticky-actions { position: sticky; top: 0.75rem; z-index: 10; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-1">译后质量诊断（DeepSeek）原型</h3>
      <div class="hint">输入原文与译文，系统将从5个维度输出结构化问题与可替换建议。</div>
    </div>
    <div class="d-flex gap-2 sticky-actions">
      <button class="btn btn-outline-secondary" type="button" id="btnExample">填充示例</button>
      <button class="btn btn-outline-secondary" type="button" id="btnClear">清空</button>
      <button class="btn btn-primary" type="submit" form="qaForm" id="btnSubmit">
        <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner"></span>
        <span id="btnText">开始诊断</span>
      </button>
    </div>
  </div>

  <!-- ✅ 关键修改：action 从 /api/diagnose 改为 /diagnose（网页提交后会跳转到 /report/{id}） -->
  <form class="card shadow-sm border-0" id="qaForm" method="post" action="/diagnose">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label fw-semibold">原文</label>
            <span class="hint">建议 1–6 段，过长可分段诊断</span>
          </div>
          <textarea class="form-control mono" name="source" id="source" rows="12" placeholder="粘贴原文…"></textarea>
        </div>

        <div class="col-12 col-lg-6">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label fw-semibold">译文</label>
            <span class="hint">系统会引用证据片段并给出替换建议</span>
          </div>
          <textarea class="form-control mono" name="target" id="target" rows="12" placeholder="粘贴译文…"></textarea>
        </div>

        <div class="col-12 col-lg-4">
          <label class="form-label fw-semibold">风格预设</label>
          <select class="form-select" name="profile" id="profile">
            <option value="general" selected>通用（优先准确，其次自然）</option>
            <option value="academic">学术（更正式、客观、简洁）</option>
            <option value="business">商务（专业、清晰、可读性）</option>
            <option value="news">新闻（准确克制、语体适中）</option>
          </select>
        </div>

        <div class="col-12 col-lg-8">
          <label class="form-label fw-semibold">使用提示</label>
          <div class="alert alert-info mb-0">
            <div class="small">
              <b>如何提升结果质量：</b>
              尽量提供完整句子；如果是术语密集文本，建议先在译文中统一术语；若模型输出不稳定，可分段诊断并合并报告。
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="text-muted small">
            注意：如遇 API 余额不足，系统将自动切换为「演示模式」返回示例诊断结果，页面会提示。
          </div>
        </div>

      </div>
    </div>
  </form>

</div>

<script>
  const sourceEl = document.getElementById("source");
  const targetEl = document.getElementById("target");
  const btnExample = document.getElementById("btnExample");
  const btnClear = document.getElementById("btnClear");
  const form = document.getElementById("qaForm");
  const spinner = document.getElementById("spinner");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnText = document.getElementById("btnText");

  btnExample.addEventListener("click", () => {
    sourceEl.value = "本研究探讨了机器学习在文本分析中的应用，并比较了不同模型在分类任务上的表现。";
    targetEl.value = "This research discusses the application of machine learning in text analysis and it should be noted that the results are very significant. We also compare different models on classification tasks.";
    document.getElementById("profile").value = "academic";
    sourceEl.focus();
  });

  btnClear.addEventListener("click", () => {
    sourceEl.value = "";
    targetEl.value = "";
    sourceEl.focus();
  });

  form.addEventListener("submit", () => {
    if (!sourceEl.value.trim() || !targetEl.value.trim()) {
      alert("原文和译文都不能为空。");
      return false;
    }
    spinner.classList.remove("d-none");
    btnSubmit.setAttribute("disabled", "disabled");
    btnText.textContent = "诊断中…";
    return true;
  });
</script>
</body>
</html>
